const fs = require("fs/promises");
const path = require("path");

const main = async ([filePath]) => {
  if (!filePath) {
    throw new Error("Missing argument `path`");
  }

  const file = await fs.readFile(path.resolve(process.cwd(), filePath));
  const data = JSON.parse(file.toString("utf-8"));

  const mappedData = data["daten"].map(([code, name, description]) => {
    const formattedCode = JSON.stringify(code);
    const formattedName = !!name ? JSON.stringify(name) : "undefined";
    const formattedDescription = !!description
      ? JSON.stringify(description)
      : "undefined";

    return `
  {
    code: ${
      formattedCode.length >= 80 - 6
        ? `\n\t\t\t${formattedCode}`
        : formattedCode
    },
    name: ${
      formattedName.length >= 80 - 6
        ? `\n\t\t\t${formattedName}`
        : formattedName
    },
    description: ${
      formattedDescription.length >= 80 - 13
        ? `\n\t\t\t${formattedDescription}`
        : formattedDescription
    },
  },`;
  });

  await fs.writeFile(
    "./packages/node-zugferd/src/codelists/generated/untdid.1001.ts",
    `export type Untdid1001Definition = {
  code: string;
  name?: string;
  description?: string;
};

export type Untdid1001Code = (typeof UNTDID_1001)[number]["code"];

/**
 * Generated by ${"`"}scripts/untdid.1001.js${"`"} on ${new Date().toUTCString()}
 * 
 * @see https://www.xrepository.de/api/xrepository/urn:xoev-de:kosit:codeliste:untdid.1001_4/download/UNTDID_1001_4.json
 */
export const UNTDID_1001 = [${mappedData.join("")}${
      mappedData.length > 0 ? "\n" : ""
    }] as const satisfies Untdid1001Definition[];`
  );
};

void main(process.argv.slice(2));
